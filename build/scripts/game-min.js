let player,playerAPI,map,isGameOn,bgAudio,isRespawn;function hideBgAudio(){(bgAudio=document.getElementById("bg-audio")).style.display="none"}function startBgAudio(){bgAudio.autoplay=!0,bgAudio.load()}function initGame(){playerAPI=new PlayerAPI,initMap(),initUI(),isGameOn=!1,isRespawn=!1}function initUI(){addTextToConsole("Bienvenido a Battle Arena! (Desarrollado por <b>Sergi Vidal</b>)"),addButtonsEvent(),blockRevivePlayerButton(),blockDeletePlayerButton(),blockRankingButton(),blockControlButtons()}function openCreatePlayerFrom(){document.getElementsByClassName("form-popup")[0].style.display="block"}function closeCreatePlayerForm(){document.getElementsByClassName("form-popup")[0].style.display="none"}function openRanking(){document.getElementById("kills").innerHTML="Your kills: "+Player.prototype.kills,blockRankingButton(),document.getElementsByClassName("ranking-popup")[0].style.display="block"}function closeRanking(){enableRankingButton(),document.getElementsByClassName("ranking-popup")[0].style.display="none"}function addButtonsEvent(){closeCreatePlayerForm(),document.getElementById("btn-close-create-player").addEventListener("click",closeCreatePlayerForm),document.getElementById("form-create-player").addEventListener("click",onClickCreateNewPlayer),document.getElementById("new-player").addEventListener("click",openCreatePlayerFrom),document.getElementById("revive-player").addEventListener("click",onClickRevivePlayer),document.getElementById("delete-player").addEventListener("click",onClickDeletePlayer),document.getElementById("ranking").addEventListener("click",onClickShowRanking),document.getElementById("btn-close-ranking").addEventListener("click",closeRanking),initPlayersControls()}function getVpPercentage(){return Math.round(player.getVp/Player.prototype.maxVp*100)}function onClickCreateNewPlayer(){document.getElementById("new-player").style.animation="none",startBgAudio();let e=document.getElementById("input-player-name").value;e.length>0&&!0!==e.startsWith(" ")?(closeCreatePlayerForm(),playerAPI.createNewPlayer(e,function(e){console.log(e),playerAPI.setToken(e),playerAPI.getCurrentPlayerInfo(playerAPI.getToken,function(e){player=new Player(e),Player.prototype.maxVp=player.getVp,updateViewWithPlayerInfo(),blockCreatePlayerButton(),enableRevivePlayerButton(),enableDeletePlayerButton(),enableRankingButton(),enableControlButtons(),getMapInfo(),getNearPlayers(),isGameOn=!0,refreshGame()})})):addTextToConsole("El nombre del jugador no debe estar vacio ni empezar por un espacio!")}function getPlayerInfo(){playerAPI.getCurrentPlayerInfo(playerAPI.getToken,function(e){resetOldPlayerPosition(),player=new Player(e),isRespawn&&(Player.prototype.maxVp=player.getVp,isRespawn=!1),updateViewWithPlayerInfo(),getMapInfo(),getNearPlayers()})}function resetOldPlayerPosition(){let e=player.getX,t=player.getY;map.getDomMatrix[t][e].style.backgroundColor="white",map.getDomMatrix[t][e].style.backgroundImage="none"}function onClickRevivePlayer(){isRespawn=!0,closeRanking(),playerAPI.respawnCurrentPlayer(playerAPI.getToken,function(){document.getElementById("revive-player").style.animation="none",getPlayerInfo()})}function onClickDeletePlayer(){closeRanking(),playerAPI.deleteCurrentPlayer(playerAPI.getToken,function(){document.getElementById("revive-player").style.animation="none",bgAudio.pause(),player=null,updateViewWithPlayerInfo(),enableCreatePlayerButton(),blockRevivePlayerButton(),blockDeletePlayerButton(),blockRankingButton(),blockControlButtons(),initMap(),restartVisor(),isGameOn=!1})}function onClickShowRanking(){playerAPI.showRanking(function(e){let t=document.getElementById("ranking-list");for(;t.firstChild;)t.removeChild(t.lastChild);Player.prototype.kills=0;let n=e.split("\n");for(let e=0;e<n.length-1;e++){let o=n[e].split(",");createElement(o[0]+" => "+o[1],t,"LI"),o[0]===player.getName&&(Player.prototype.kills=Player.prototype.kills+1)}openRanking()})}function initMap(){(map=new Map).initDomMatrix(),createMap()}function restartVisor(){document.querySelectorAll(".view").forEach(function(e){e.style.backgroundImage="none"})}function updateViewWithPlayerInfo(){let e=document.getElementById("stats");e.innerHTML="",null!==player?(document.getElementById("player-image").src=player.getImg,createElement("Name: "+player.name,e,"H3"),createElement("Attack: "+player.attack,e,"H3"),createElement("Defense: "+player.defense,e,"H3"),createElement("",e,"H3"),player.getVp>0?e.lastChild.innerHTML="Vitality Points: "+player.getVp+" ("+getVpPercentage()+"%)":(addTextToConsole("<b>Has muerto! Haz click en el bot√≥n Respawn Player!</b>"),document.getElementById("revive-player").style.animation="createPlayerAnimation 5s infinite",e.lastChild.innerHTML="Vitality Points: 0 (0%)")):(document.getElementById("player-image").src="images/skull.png",createElement("Name: -",e,"H3"),createElement("Attack: -",e,"H3"),createElement("Defense: -",e,"H3"),createElement("Vitality Points: -",e,"H3"))}function createElement(e,t,n){let o=document.createElement(n),l=document.createTextNode(e);o.appendChild(l),t.appendChild(o)}function blockCreatePlayerButton(){let e=document.getElementById("new-player");e.style.pointerEvents="none",e.style.backgroundColor="grey"}function blockRevivePlayerButton(){let e=document.getElementById("revive-player");e.style.pointerEvents="none",e.style.backgroundColor="grey"}function blockDeletePlayerButton(){let e=document.getElementById("delete-player");e.style.pointerEvents="none",e.style.backgroundColor="grey"}function blockRankingButton(){let e=document.getElementById("ranking");e.style.pointerEvents="none",e.style.backgroundColor="grey"}function enableCreatePlayerButton(){let e=document.getElementById("new-player");e.style.pointerEvents="auto",e.style.backgroundColor="#ec2d42"}function enableRevivePlayerButton(){let e=document.getElementById("revive-player");e.style.pointerEvents="auto",e.style.backgroundColor="#ec2d42"}function enableDeletePlayerButton(){let e=document.getElementById("delete-player");e.style.pointerEvents="auto",e.style.backgroundColor="#ec2d42"}function enableRankingButton(){let e=document.getElementById("ranking");e.style.pointerEvents="auto",e.style.backgroundColor="#ec2d42"}function addTextToConsole(e){let t=document.getElementById("console");t.innerHTML="["+getTime()+"]: "+e+"</br>"+t.innerHTML}function createMap(){let e=document.getElementById("map");for(;e.firstChild;)e.removeChild(e.lastChild);for(let t=0;t<ROWS;t++)for(let n=0;n<COLUMNS;n++){let o=document.createElement("DIV");o.setAttribute("class","cell"),e.appendChild(o),map.setDomCell(t,n,o)}}function getTime(){let e=function(e){return e<10?"0"+e:e},t=new Date;return[e(t.getHours()),e(t.getMinutes()),e(t.getSeconds())].join(":")}function initPlayersControls(){initAttackControls(),initMoveControls()}function initAttackControls(){document.getElementById("attack-north").addEventListener("click",function(){onClickAttack("N")}),document.getElementById("attack-west").addEventListener("click",function(){onClickAttack("O")}),document.getElementById("attack-east").addEventListener("click",function(){onClickAttack("E")}),document.getElementById("attack-south").addEventListener("click",function(){onClickAttack("S")})}function initMoveControls(){document.getElementById("move-northWest").addEventListener("click",function(){onClickDiagonalMove("N","O")}),document.getElementById("move-north").addEventListener("click",function(){onClickMove("N")}),document.getElementById("move-northEast").addEventListener("click",function(){onClickDiagonalMove("N","E")}),document.getElementById("move-west").addEventListener("click",function(){onClickMove("O")}),document.getElementById("move-east").addEventListener("click",function(){onClickMove("E")}),document.getElementById("move-southWest").addEventListener("click",function(){onClickDiagonalMove("S","O")}),document.getElementById("move-south").addEventListener("click",function(){onClickMove("S")}),document.getElementById("move-southEast").addEventListener("click",function(){onClickDiagonalMove("S","E")})}function blockControlButtons(){document.querySelectorAll(".box").forEach(function(e){e.style.pointerEvents="none",e.style.opacity="0.7"})}function enableControlButtons(){document.querySelectorAll(".box").forEach(function(e){e.style.pointerEvents="auto",e.style.opacity="1",e.style.backgroundColor="white"})}function onClickAttack(e){blockControlButtons(),playerAPI.attackPlayer(playerAPI.getToken,e,function(){})}function onClickMove(e){blockControlButtons(),playerAPI.movePlayer(playerAPI.getToken,e,function(){getPlayerInfo()})}function onClickDiagonalMove(e,t){blockControlButtons(),playerAPI.movePlayer(playerAPI.getToken,e,function(){getPlayerInfo(),setTimeout(function(){playerAPI.movePlayer(playerAPI.getToken,t,function(){getPlayerInfo()})},1e3)})}function initCornerVisors(){let e="url('images/floor.png')",t="url('images/wall.png')",n=document.getElementById("nw-visor");setVisorImage(n,e);let o=document.getElementById("n-visor");setVisorImage(o,e);let l=document.getElementById("ne-visor");setVisorImage(l,e);let a=document.getElementById("mw-visor");setVisorImage(a,e),setVisorImage(document.getElementById("m-visor"),e);let r=document.getElementById("me-visor");setVisorImage(r,e);let i=document.getElementById("sw-visor");setVisorImage(i,e);let s=document.getElementById("s-visor");setVisorImage(s,e);let c=document.getElementById("se-visor");setVisorImage(c,e);let m=player.getX,g=player.getY;0===g&&(setVisorImage(o,t),setVisorImage(n,t),setVisorImage(l,t)),0===m&&(setVisorImage(a,t),setVisorImage(n,t),setVisorImage(i,t)),m+1===COLUMNS&&(setVisorImage(r,t),setVisorImage(l,t),setVisorImage(c,t)),g+1===ROWS&&(setVisorImage(s,t),setVisorImage(i,t),setVisorImage(c,t)),0===g&&0===m&&(setVisorImage(n,t),setVisorImage(l,t),setVisorImage(i,t)),0===g&&m+1===COLUMNS&&(setVisorImage(l,t),setVisorImage(n,t),setVisorImage(c,t)),g+1===ROWS&&0===m&&(setVisorImage(i,t),setVisorImage(n,t),setVisorImage(c,t)),g+1===ROWS&&m+1===COLUMNS&&(setVisorImage(c,t),setVisorImage(l,t),setVisorImage(i,t))}function updateVisor(e){if(player.getName!==e.getName&&e.getVp>0){let t="url('images/enemy.png')",n=e.getX,o=e.getY,l=document.getElementById("nw-visor"),a=document.getElementById("n-visor"),r=document.getElementById("ne-visor"),i=document.getElementById("mw-visor"),s=document.getElementById("m-visor"),c=document.getElementById("me-visor"),m=document.getElementById("sw-visor"),g=document.getElementById("s-visor"),y=document.getElementById("se-visor");o===player.getY-1&&n===player.getX-1?setVisorImage(l,t):o===player.getY-1&&n===player.getX?setVisorImage(a,t):o===player.getY-1&&n===player.getX+1?setVisorImage(r,t):o===player.getY&&n===player.getX-1?setVisorImage(i,t):o===player.getY&&n===player.getX?setVisorImage(s,t):o===player.getY&&n===player.getX+1?setVisorImage(c,t):o===player.getY+1&&n===player.getX-1?setVisorImage(m,t):o===player.getY+1&&n===player.getX?setVisorImage(g,t):o===player.getY+1&&n===player.getX+1&&setVisorImage(y,t)}}function setVisorImage(e,t){e.style.backgroundImage=t,e.style.backgroundSize="135px",e.style.backgroundRepeat="no-repeat"}function getNearPlayers(){playerAPI.getNearPlayers(playerAPI.getToken,function(e){initCornerVisors();for(let t=0;t<e.length;t++){let n=new Player(e[t]);updateVisor(n),updateMapColorCell(n)}})}function updateMapColorCell(e){if(player.getName!==e.getName&&e.getVp<=0){let t=map.getDomCell(e.getY,e.getX);t.style.backgroundImage="none",t.style.backgroundColor="grey"}}function resetOldMapInfo(){for(let e=0;e<map.getDomMatrix.length;e++)for(let t=0;t<map.getDomMatrix[e].length;t++)map.getDomMatrix[e][t].style.backgroundColor="white"}function getMapInfo(){playerAPI.getMapInfo(function(e){resetOldMapInfo();for(let t=0;t<e.length;t++){let n=e[t][0],o=e[t][1],l=map.getDomCell(o,n);l.style.backgroundImage="none",l.style.backgroundColor="#ec2d42"}let t=player.getX,n=player.getY,o=player.getD;map.getDomCell(n,t).style.backgroundColor="blue";let l=map.getDomCell(n,t);l.style.backgroundImage="url('images/player-dir.png')",l.style.backgroundSize="15px",l.style.backgroundRepeat="no-repeat",l.style.backgroundPosition="center",l.style.transform="E"===o?"rotate(90deg)":"S"===o?"rotate(180deg)":"O"===o?"rotate(-90deg)":"rotate(0)"})}function refreshGame(){isGameOn&&setTimeout(playerAPI.fetchRefreshGame,2e3)}window.onload=function(){hideBgAudio(),initGame()};